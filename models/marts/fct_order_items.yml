models:
  - name: fct_order_items
    columns:
      - name: order_item_id
        data_tests:
          - not_null
          - unique
        entity:
          type: primary
          name: order_item
      - name: order_id
        data_tests:
          - relationships:
              arguments:
                to: ref('fct_orders')
                field: order_id
        entity:
          type: foreign
      - name: product_id
        entity:
          type: foreign
          name: product
      - name: ordered_at
        dimension:
          type: time
        granularity: day
      - name: is_food_item
        dimension:
          type: categorical
      - name: is_drink_item
        dimension:
          type: categorical

    semantic_model:
      enabled: true
    description: |
      Items contatined in each order. The grain of the table is one row per order item.
    agg_time_dimension: ordered_at
    metrics:
      - name: revenue
        description: The revenue generated for each order item. Revenue is calculated as a sum of revenue associated with each product in an order.
        agg: sum
        expr: product_price
        type: simple
      - name: food_revenue
        description: The revenue generated for each order item. Revenue is calculated as a sum of revenue associated with each product in an order.
        agg: sum
        expr: case when is_food_item = 1 then product_price else 0 end
        type: simple
      - name: drink_revenue
        description: The revenue generated for each order item. Revenue is calculated as a sum of revenue associated with each product in an order.
        agg: sum
        expr: case when is_drink_item = 1 then product_price else 0 end
        type: simple
      - name: median_revenue
        description: The median revenue generated for each order item.
        agg: median
        expr: product_price
        type: simple
      - name: food_revenue_pct
        description: The % of order revenue from food.
        label: Food Revenue %
        type: ratio
        numerator: food_revenue
        denominator: revenue
      - name: drink_revenue_pct
        description: The % of order revenue from drinks.
        label: Drink Revenue %
        type: ratio
        numerator: drink_revenue
        denominator: revenue
      - name: revenue_growth_mom
        description: Percentage growth of revenue compared to 1 month ago. Excluded tax
        type: derived
        label: Revenue Growth % M/M
        expr: (current_revenue - revenue_prev_month)*100/revenue_prev_month
        input_metrics:
          - name: revenue
            alias: current_revenue
          - name: revenue
            offset_window: 1 month
            alias: revenue_prev_month

      - name: cumulative_revenue
        description: The cumulative revenue for all orders.
        label: Cumulative Revenue (All Time)
        type: cumulative
        input_metric: revenue
unit_tests:
  - name: test_supply_costs_sum_correctly
    description: "Test that the counts of drinks and food orders convert to booleans properly."
    model: fct_order_items
    given:
      - input: ref('stg_jaffle_shop__supplies')
        rows:
          - {product_id: 1, supply_cost: 4.50}
          - {product_id: 2, supply_cost: 3.50}
          - {product_id: 2, supply_cost: 5.00}
      - input: ref('stg_jaffle_shop__products')
        rows:
          - {product_id: 1}
          - {product_id: 2}
      - input: ref('stg_jaffle_shop__order_items')
        rows:
          - {order_id: 1, product_id: 1}
          - {order_id: 2, product_id: 2}
          - {order_id: 2, product_id: 2}
      - input: ref('stg_jaffle_shop__orders')
        rows:
          - {order_id: 1}
          - {order_id: 2}
    expect:
      rows:
        - {order_id: 1, product_id: 1, supply_cost: 4.50}
        - {order_id: 2, product_id: 2, supply_cost: 8.50}
        - {order_id: 2, product_id: 2, supply_cost: 8.50}

metrics:
  - name: order_gross_profit
    description: Gross profit from each order.
    type: derived
    label: Order Gross Profit
    expr: revenue - cost
    input_metrics:
      - name: revenue
      - name: order_cost
        alias: cost

  #Cumulative Metrics
saved_queries:
  - name: revenue_metrics
    query_params:
      metrics:
        - revenue
        - food_revenue
        - drink_revenue
      group_by:
        - TimeDimension('metric_time', 'day')
    exports:
      - name: revenue_metrics
        config:
          export_as: table